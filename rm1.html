#!/usr/bin/node
//; xterm-send "echo -ne \"\\033c\"; node $0 rm.rm" ; exit 1 ;

//<body style="overflow: scroll; font-family: monospace;"><button id="run">run</button><input type="checkbox" id="livepreview" style="vertical-align: middle;"><label for="livepreview">live preview</label><input type="text" disabled id="input" min="0" oninput="validity.valid||(value='');" placeholder="r0 // input" style="width:100%; height:auto;"><input type="text" id="input-text" placeholder="r0 // text input" style="width:100%; height:auto;"></input><textarea id="source" style="width:100%; height:80%; white-space: pre;"></textarea><div id="output" style="line-break: anywhere;"></div><script>window.addEventListener("load",function() { document.body.childNodes[0].textContent = ""; });

function parserReadShebang(input)
{
  if (input.startsWith("#!"))
  {
    let end = input.indexOf("\n", 0);
    if (end === -1) end = input.length;
    return end;
  }
  return 0;
}

function parserSkipSpace(input,index)
{
  while (true)
  {
    const space = /[ \t\r\n]/.exec(input.slice(index));
    const commentLine = /^\/\/[^\n\r]*/.exec(input.slice(index));
    const commentBlock = /^\/\*(?:[^*]|\*(?!\/))*\*\//.exec(input.slice(index));
    if (space && space.index === 0) index++;
    else if (commentLine && commentLine.index === 0) index += commentLine[0].length;
    else if (commentBlock && commentBlock.index === 0) index += commentBlock[0].length;
    else return index;
  }
}

function parserReadNumber(input,index)
{
  index = parserSkipSpace(input,index);
  const match = /^0|[1-9][0-9]*/.exec(input.slice(index));
  if (match)
  {
    index += match[0].length;
    return { type: "number", value: match[0], index };
  }
  return {message: "expected a number", index};
}

function parserReadInstruction(input,index)
{
  index = parserSkipSpace(input,index);
  if (!(input.startsWith("inc", index)||input.startsWith("dec", index)||input.startsWith("jnz", index))) return {message: `expect 'inc' 'dec' or 'jnz'`, index};
  const name = input.substring(index,index+3);
  index += 3;
  let op1 = parserReadNumber(input,index);
  if (op1.message) return op1;
  index = parserSkipSpace(input,op1.index);
  let op2;
  if(name==="jnz")
  {
    op2 = parserReadNumber(input,index);
    if (op2.message) return op2;
    index = parserSkipSpace(input,op2.index);
  }
  return {
    type: "Instruction",
    name,
    op1:BigInt(op1.value),
    op2:BigInt(op2?op2.value?op2.value:0n:0n),
    index,
  };
}

function parserReadProgram(input)
{
  let index = 0;
  index = parserReadShebang(input);
  index = parserSkipSpace(input,index);
  let instructions = [];
  while(index<input.length)
  {
    const f = parserReadInstruction(input,index);
    if (f.message) return f;
    instructions.push(f);
    index = f.index;
  }
  return {
    type: "Program",
    instructions,
  };
}

function parserGetLineAndColumn(input,index)
{
  let src = input.substring(0,index+1);
  let l = src.split('\n').length;
  let c = src.length-src.lastIndexOf('\n')-1;
  return [l,c];
}

function parse(source)
{
  let ast = parserReadProgram(source);
  if(ast.message) { ast.lineandcolumn = parserGetLineAndColumn(source,ast.index); return ast; }
  return ast;
}

function rm(src,...args)
{
  let ast = parse(src);
  if(ast.message) return "syntax error: " + ast.message + " at " + ast.lineandcolumn;
  try
  {
    let regs = args;
    let i=0n;
    while(i<ast.instructions.length)
    {
      let inst = ast.instructions[i]; 
      switch(inst.name)
      {
        case "jnz": if(regs[inst.op1]) { if(inst.op2===i) return ""; i = inst.op2; continue; } break;
        case "inc": if(regs[inst.op1]) regs[inst.op1]++; else regs[inst.op1] = 1n; break;
        case "dec": if(regs[inst.op1]) regs[inst.op1]--; break;
      }
      i+=1n;
    }
    return regs[0]||0n;
  }
  catch(e)
  {
    return('runtime error: ' + e.message);
  }
}

function root(a,b)
{
  try
  {
    let s = a + 1n; 
    let k1 = b - 1n; 
    let u = a; 
    while (u < s) 
    { 
      s = u; 
      u = ((u*k1) + a / (u ** k1)) / b; 
    } 
    return s; 
  }
  catch(e)
  {
    return 0n;
  }
}

function cantorPair(a,b) { return (a+b)*(a+b+1n)/2n+b; }
function cantorUnpair(n)
{
  let w = ((root(8n * n + 1n,2n)) - 1n) / 2n; 
  let t = (w * w + w) / 2n; 
  let y = n - t; 
  let x = w - y; 
  return [x,y];
}

function pair(a,b) { return 2n**a*(2n*b+1n)-1n; }
function unpair(n) { let a=0n; n+=1n; while(!(n%2n)) { n = n/2n; a += 1n; } return [a,(n-1n)/2n]; }

let textEncode = new TextEncoder();
let textDecode = new TextDecoder();

function stringToN(s)
{
  let r = 0n;
  let z = 0n;
  s = textEncode.encode(s); 
  for(let i=0;i<s.length;i+=1) r += BigInt(s[i])*256n**BigInt(s.length-i-1);
  for(let i=0;i<s.length&&s[i]==0;i+=1) z += 1n;
  //return cantorPair(z,r);
  return pair(z,r);
}

function nToString(n)
{
  //let [l,m] = cantorUnpair(n);
  let [l,m] = unpair(n);
  let r = [];
  let k = m;
  while(k) 
  {
    r.push(Number(k%256n));
    k = k/256n;
  }
  return textDecode.decode(new Uint8Array((new Array(Number(l))).fill(0).concat(r.reverse())));
}

if(typeof(window)==="undefined") 
{
  if (require.main === module)
  {
    try
    {
      let fs = require("fs");
      let source = fs.readFileSync(process.argv[2],"utf8").toString();
      process.argv.splice(0,3);
      let args = process.argv.map((i)=> { try{ return fs.readFileSync(i,"utf8"); } catch(e) { return ""; } }).map(stringToN);
      let r = (rm(source,...args));
      if(r!=="") console.log(nToString(r));
    }
    catch(e)
    {
      console.log("unexpected runtime error: " + e.message);
    }
  }
  else
  {
    module.exports = rm;
  }
}
else 
{
  let $source = document.getElementById("source");
  let $inputText = document.getElementById("input-text");
  let $input = document.getElementById("input");
  $source.textContent = ``;
  $input.value = "";
  $inputText.value = "hello world";
  let $output = document.getElementById("output");
  let $run = document.getElementById("run");
  let $livepreview = document.getElementById("livepreview");
  function run(e) 
  {
    try
    {
      $output.textContent = "computing...";
      if(e.target===$inputText) $input.value = stringToN($inputText.value).toString();
      else if(e.target===$input) $inputText.value = nToString(BigInt($input.value));
    }
    catch(e)
    {
      $output.textContent = ("Unexpected runtime error: " + e.message);
    }
    setTimeout(function()
    {
      try
      {
        let r = rm($source.value,...[BigInt($input.value)]);
        $output.textContent = typeof(r)!=="string"?nToString(r)+"\n":r;
      }
      catch(e)
      {
        $output.textContent = ("unexpected runtime error: " + e.message);
      }
    },0);
  }
  $run.addEventListener("click",run);
  $source.addEventListener("keydown",function(e) { if(e.keyCode == 13 && e.ctrlKey) { run(e); } });
  $input.addEventListener("keydown",function(e) { if(e.keyCode == 13) { run(e); } });
  $inputText.addEventListener("keydown",function(e) { if(e.keyCode == 13) { run(e); } });
  $livepreview.addEventListener("change", function(e) { if(e.target.checked) { $source.addEventListener("keyup", run); $input.addEventListener("keyup", run); $inputText.addEventListener("keyup", run); } else { $source.removeEventListener("keyup", run); $input.removeEventListener("keyup", run); $inputText.removeEventListener("keyup", run); } run(e); });
  $livepreview.checked = true;
  $livepreview.dispatchEvent(new Event("change"));
  run({target:$inputText});
}

//</script></body>
